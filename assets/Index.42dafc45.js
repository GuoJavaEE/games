var t=Object.defineProperty,e=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(e,o,s)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[o]=s,r=(t,r)=>{for(var c in r||(r={}))o.call(r,c)&&i(t,c,r[c]);if(e)for(var c of e(r))s.call(r,c)&&i(t,c,r[c]);return t};import{g as c,a as l,i as n,b as a,d as h}from"./utils.eaeab82e.js";import{p as d,e as w,o as f,c as m,f as v,w as u}from"./vendor.eda28678.js";class p{constructor(t,e={}){this.cvs=t,this.callbacks=e,this.rows=0,this.cols=0,this.repeatCount=4,this.imgOptions={src:"./assets/sprite.3203ac76.png",rows:4,cols:4},this.pixRatio=1,this.blockSize=0,this.blockSpace=0,this.blocks=[],this.ctx=t.getContext("2d"),this.pixRatio=c(this.ctx),this.blockSpace=3*this.pixRatio}start(t,e){t&&(this.imgOptions=t),e&&(this.repeatCount=e),this.updateSize(),this.genBlocks().then((t=>{this.blocks=t,this.drawUI(),this.addListeners()}))}updateSize(){var t;const e=this.imgOptions,[o,s]=l(e.rows*e.cols*this.repeatCount),i=this.cvs.offsetWidth*this.pixRatio,r=(null==(t=this.cvs.parentElement)?void 0:t.offsetHeight)*this.pixRatio;this.rows=r>i?s:o,this.cols=i>r?s:o;const c=(r-this.blockSpace*(this.rows-1))/(this.rows+1),n=(i-this.blockSpace*(this.cols-1))/(this.cols+1);this.blockSize=Math.min(c,n),this.cvs.width=i,this.cvs.height=(this.rows+1)*this.blockSize+(this.rows-1)*this.blockSpace}genSpriteItems(){const t=this.imgOptions;return n(t.src).then((e=>{const o=e.width/t.cols,s=a(t.rows).reduce(((s,i,r)=>s.concat(a(t.cols).map(((t,s)=>({dw:o,img:e,dx:o*s,dy:o*r}))))),[]);return a(this.repeatCount).reduce((t=>t.concat(s)),[]).sort((()=>Math.random()-.5))}))}genBlocks(){return this.genSpriteItems().then((t=>[...a(this.rows).reduce(((t,e,o)=>t.concat(a(this.cols).map(((t,e)=>({row:o+1,col:e+1}))))),[]).map(((e,o)=>r(r({},e),t[o]))),...a(this.rows+2).map(((t,e)=>({row:e,col:0,removed:!0}))),...a(this.rows+2).map(((t,e)=>({row:e,col:this.cols+1,removed:!0}))),...a(this.cols+2).map(((t,e)=>({col:e,row:0,removed:!0}))),...a(this.cols+2).map(((t,e)=>({col:e,row:this.rows+1,removed:!0})))].sort(((t,e)=>t.row-e.row||t.col-e.col))))}getCurBlock(t){const e=(t.offsetX||t.pageX)*this.pixRatio,o=(t.offsetY||t.pageY)*this.pixRatio,{blockSize:s,blockSpace:i}=this;return this.blocks.filter((t=>!t.removed)).find((t=>{const r=(t.col-1)*i+t.col*s,c=(t.row-1)*i+t.row*s;return Math.pow(e-r,2)+Math.pow(o-c,2)<Math.pow(s/2,2)}))}isSameBlock(t,e){return Math.round(t.dx)===Math.round(e.dx)&&Math.round(t.dy)===Math.round(e.dy)}getBlockCenter(t){const{blockSize:e,blockSpace:o}=this;return 0===t.col?[e/4,t.row*e+(t.row-1)*o]:0===t.row?[t.col*e+(t.col-1)*o,e/4]:t.col===this.cols+1?[t.col*e+(t.col-1)*o-e/4,t.row*e+(t.row-1)*o]:t.row===this.rows+1?[t.col*e+(t.col-1)*o,t.row*e+(t.row-1)*o-e/4]:[t.col*e+(t.col-1)*o,t.row*e+(t.row-1)*o]}rinse(){this.selectedBlock=void 0;const t=this.blocks.filter((t=>!t.removed)),e=t.map((t=>({dx:t.dx,dy:t.dy})));e.sort((t=>Math.random()-.5)),t.forEach(((t,o)=>{const s=e[o];t.dx=s.dx,t.dy=s.dy})),this.drawUI()}findWay(t,e){return this.lineDirect(t,e)||this.oneCorner(t,e)||this.twoCorner(t,e)}lineDirect(t,e){const o=[t,e].map(this.getBlockCenter.bind(this));if(t.row===e.row){const s=this.blocks.filter((e=>e.row===t.row));if(t.col<e.col){if(s.filter((o=>o.col>t.col&&o.col<e.col)).every((t=>t.removed)))return o}else if(s.filter((o=>o.col>e.col&&o.col<t.col)).every((t=>t.removed)))return o}else if(t.col===e.col){const s=this.blocks.filter((e=>e.col===t.col));if(t.row<e.row){if(s.filter((o=>o.row>t.row&&o.row<e.row)).every((t=>t.removed)))return o}else if(s.filter((o=>o.row>e.row&&o.row<t.row)).every((t=>t.removed)))return o}}oneCorner(t,e){const o=o=>[t,o,e].map(this.getBlockCenter.bind(this));let s=this.blocks.find((o=>o.row===t.row&&o.col===e.col));return(null==s?void 0:s.removed)&&this.lineDirect(t,s)&&this.lineDirect(s,e)?o(s):(s=this.blocks.find((o=>o.row===e.row&&o.col===t.col)),(null==s?void 0:s.removed)&&this.lineDirect(t,s)&&this.lineDirect(s,e)?o(s):void 0)}twoCorner(t,e){const o=this.blocks.filter((e=>e.row===t.row)),s=this.blocks.filter((e=>e.col===t.col)),i=s.filter((e=>e.row<t.row)),r=o.filter((e=>e.col>t.col)),c=s.filter((e=>e.row>t.row)),l=o.filter((e=>e.col<t.col)),n=o=>{const s=this.oneCorner(o,e);if(s)return[t,o].map(this.getBlockCenter.bind(this)).concat(s.slice(1))};for(let a=i.length-1;a>=0;a--){const t=i[a];if(!t.removed)break;const e=n(t);if(e)return e}for(let a=0;a<r.length;a++){const t=r[a];if(!t.removed)break;const e=n(t);if(e)return e}for(let a=0;a<c.length;a++){const t=c[a];if(!t.removed)break;const e=n(t);if(e)return e}for(let a=l.length-1;a>=0;a--){const t=l[a];if(!t.removed)break;const e=n(t);if(e)return e}}drawUI(){const{blockSize:t,blockSpace:e}=this;this.ctx.clearRect(0,0,this.cvs.width,this.cvs.height),this.blocks.forEach((o=>{o.removed||this.ctx.drawImage(o.img,o.dx,o.dy,o.dw,o.dw,t/2+(o.col-1)*t+(o.col-1)*e,t/2+(o.row-1)*t+(o.row-1)*e,t,t)})),this.selectedBlock&&this.drawArc(this.selectedBlock)}drawArc(t,e=.6){const{ctx:o}=this;o.save(),o.fillStyle=`rgba(0,0,0,${e})`,o.beginPath(),o.arc(...this.getBlockCenter(t),this.blockSize/2,0,2*Math.PI),o.closePath(),o.fill(),o.restore()}drawJoinLine(t){if(2===t.length){const[e,o]=t,s=this.blockSize+this.blockSpace;if(!Math.round(Math.abs(e[0]-o[0])-s)||!Math.round(Math.abs(e[1]-o[1])-s))return}const{ctx:e}=this;e.save(),e.strokeStyle="#555",e.lineWidth=this.pixRatio,e.beginPath(),e.moveTo(...t[0]),t.slice(1).forEach((t=>{e.lineTo(...t)})),e.stroke(),e.restore()}addListeners(){this.cvs.addEventListener("click",this.onClick.bind(this)),window.addEventListener("resize",this.onResize.bind(this))}removeListeners(){this.cvs.removeEventListener("click",this.onClick),window.removeEventListener("resize",this.onResize)}onClick(t){const e=this.getCurBlock(t);if(e){const{selectedBlock:t}=this;if(t){if(e===t)return;if(this.isSameBlock(t,e)){const o=this.findWay(t,e);if(o)return this.drawArc(e),t.removed=e.removed=!0,this.selectedBlock=void 0,this.drawJoinLine(o),setTimeout((()=>{this.drawUI(),this.blocks.every((t=>t.removed))&&h(this.callbacks.onDone)}),200)}}this.selectedBlock=e,this.drawUI()}}onResize(){this.updateSize(),this.drawUI()}}var k={data:()=>({game:null}),mounted(){const t=new p(this.$refs.ui,{onDone:()=>{alert("恭喜你，挑战成功！"),t.start()},onFailed:()=>{}});t.start(),this.game=t},unmounted(){this.game&&(this.game.removeListeners(),this.game=null)},methods:{onRinse(){var t;null==(t=this.game)||t.rinse()},onReStart(){var t;null==(t=this.game)||t.start()}}};const b=u();d("data-v-8aa64f56");const g={class:"container"},S={class:"dashboard"},x=v("div",{class:"title"},"经典连连看",-1),y={class:"btns"},C={class:"game-ui"},R={ref:"ui"};w();const B=b(((t,e,o,s,i,r)=>(f(),m("div",g,[v("div",S,[x,v("div",y,[v("button",{onClick:e[1]||(e[1]=(...t)=>r.onReStart&&r.onReStart(...t))},"重新开始"),v("button",{onClick:e[2]||(e[2]=(...t)=>r.onRinse&&r.onRinse(...t))},"洗 牌")])]),v("div",C,[v("canvas",R,null,512)])]))));k.render=B,k.__scopeId="data-v-8aa64f56";export default k;
