import{g as s,d as t,a as i,c as o}from"./utils.3a965408.js";import{p as e,e as h,o as c,c as r,f as l,w as a}from"./vendor.eda28678.js";class n{constructor(s,t,i){this.row=s,this.col=t,this.color=i}draw(s,t,i,o){const e=(t+o)*this.col,h=(i+o)*this.row;s.save(),s.fillStyle=this.color,s.fillRect(e,h,t,i),s.restore()}}class d{constructor(t,i={}){this.cvs=t,this.callbacks=i,this.rows=10,this.cols=10,this.blocks=[],this.colors=["#22a6ea","#f44e4e","#b3cc25","#f1a30c","#b854e6"],this.bWidth=0,this.bHeight=0,this.score=0,this.ctx=t.getContext("2d"),this.pixRatio=s(this.ctx),this.bSpace=this.pixRatio,this.addListeners()}start(s={}){if(s.rows&&(this.rows=s.rows),this.cols=s.cols||s.rows||this.cols,s.colors){if(s.colors.length<3)return t(this.callbacks.onError,new Error("请至少提供3种色值！"),0);this.colors=s.colors}this.score=0,this.updateSize(),this.blocks=this.genBlocks(),this.drawUI()}updateSize(){var s;const t=this.cvs.offsetWidth*this.pixRatio;this.bWidth=(t-(this.cols-1)*this.bSpace)/this.cols;const i=(null==(s=this.cvs.parentElement)?void 0:s.offsetHeight)*this.pixRatio;this.bHeight=this.bWidth*this.rows+(this.rows-1)*this.bSpace<i?this.bWidth:(i-(this.rows-1)*this.bSpace)/this.rows,this.cvs.width=t,this.cvs.height=this.bHeight*this.rows+(this.rows-1)*this.bSpace}drawUI(){const{ctx:s,cvs:t}=this;s.clearRect(0,0,t.width,t.height),this.blocks.forEach((t=>{t.draw(s,this.bWidth,this.bHeight,this.bSpace)}))}genBlocks(){const{colors:s}=this,t=this.rows*this.cols,e=[...s,...s,...i(t-2*s.length).map((()=>s[o(0,s.length-1)]))].sort((()=>Math.random()-.5)),h=i(this.rows).reduce(((s,t,o)=>[...s,...i(this.cols).map(((s,t)=>new n(o,t,"#000")))]),[]);return h.forEach(((s,t)=>{s.color=e[t]})),h}getCurBlock(s){const{bWidth:t,bHeight:i,bSpace:o}=this,e=(s.offsetX||s.pageX)*this.pixRatio,h=(s.offsetY||s.pageY)*this.pixRatio;return this.blocks.find((s=>{const c=(t+o)*s.col,r=(i+o)*s.row;return e>c&&e<c+t&&h>r&&h<r+i}))}getSameBlocks(s){const t=(s,t)=>this.blocks.find((i=>i.row===s&&i.col===t)),i=[s],o=[];for(;i.length;){const e=i.pop();o.push(e),[t(e.row-1,e.col),t(e.row,e.col+1),t(e.row+1,e.col),t(e.row,e.col-1)].filter((t=>t&&t.color===s.color)).forEach((s=>{!o.includes(s)&&!i.includes(s)&&i.push(s)}))}return o}removeBlocks(s){s.forEach((s=>{this.blocks.splice(this.blocks.indexOf(s),1)}))}drawScores(s){const t=`+${s.length}`,{bWidth:i,bHeight:o,bSpace:e,ctx:h}=this,c=Math.min(.4*i,.4*o)+"px",r=h.measureText(t).width;return h.save(),h.font=`bold ${c} serif`,h.textAlign="center",h.textBaseline="middle",h.fillStyle="#555",s.forEach((s=>{const c=(i+e)*s.col+(i-r)/2+this.pixRatio,l=(o+e)*s.row+(o-r)/2+4*this.pixRatio;h.fillText(t,c,l)})),h.restore(),new Promise((s=>setTimeout(s,300)))}moveBlocks(s){this.blocks.forEach((t=>{t.row+=s.filter((s=>s.col===t.col&&s.row>t.row)).length}));const t=i(this.cols).map(((s,t)=>t)).filter((s=>!this.blocks.filter((t=>t.col===s)).length));this.blocks.forEach((s=>{s.col-=t.filter((t=>t<s.col)).length}))}isDone(){return this.blocks.every((s=>this.getSameBlocks(s).length<2))}onClick(s){const i=this.getCurBlock(s);if(i){const s=this.getSameBlocks(i),o=s.length;o>1&&(this.score+=o*o,this.removeBlocks(s),this.drawUI(),this.moveBlocks(s),this.drawScores(s).then((()=>{this.drawUI(),this.isDone()&&t(this.callbacks.onDone,this.score)})))}}onResize(){this.updateSize(),this.drawUI()}addListeners(){this.cvs.addEventListener("click",this.onClick.bind(this)),window.addEventListener("resize",this.onResize.bind(this))}removeListeners(){this.cvs.removeEventListener("click",this.onClick),window.removeEventListener("resize",this.onResize)}}var w={data:()=>({game:null}),mounted(){this.game=new d(this.$refs.canvas,{onDone:s=>{var t;alert(`没有可消除的方块了，你的得分: ${s}`),null==(t=this.game)||t.start()}}),this.game.start()},unmounted(){var s;null==(s=this.game)||s.removeListeners(),this.game=null},methods:{onStart(){var s;null==(s=this.game)||s.start()}}};const b=a();e("data-v-40a9a9e8");const f={class:"container"},v={class:"dashboard"},g=l("div",{class:"title"},"经典消消看",-1),m={class:"btns"},p={class:"game-ui"},u={ref:"canvas"};h();const k=b(((s,t,i,o,e,h)=>(c(),r("div",f,[l("div",v,[g,l("div",m,[l("button",{onClick:t[1]||(t[1]=(...s)=>h.onStart&&h.onStart(...s))},"新游戏")])]),l("div",p,[l("canvas",u,null,512)])]))));w.render=k,w.__scopeId="data-v-40a9a9e8";export default w;
