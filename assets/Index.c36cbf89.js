import{g as t,a as s,r as e,d as o}from"./utils.3a965408.js";import{p as i,e as r,o as c,c as l,f as a,w as n}from"./vendor.eda28678.js";var h,f;(f=h||(h={}))[f.UP=1]="UP",f[f.RIGHT=2]="RIGHT",f[f.DOWN=3]="DOWN",f[f.LEFT=4]="LEFT";const d={2:{color:"#333",bgcolor:"#eee4da"},4:{color:"#333",bgcolor:"#ece0ca"},8:{color:"#f7f7f5",bgcolor:"#f2b179"},16:{color:"#f7f7f5",bgcolor:"#f59563"},32:{color:"#f7f7f5",bgcolor:"#f57c5f"},64:{color:"#f7f7f5",bgcolor:"#ff5734"},128:{color:"#f7f7f5",bgcolor:"#f4cc6d"},256:{color:"#f7f7f5",bgcolor:"#d65211"},512:{color:"#f7f7f5",bgcolor:"#e29441"},1024:{color:"#f7f7f5",bgcolor:"#9e790a"},2048:{color:"#fefdf9",bgcolor:"#e0ba01"}};class u{constructor(t,s){this.cvs=t,this.callbacks=s,this.rows=4,this.cols=4,this.pixRatio=1,this.bSize=0,this.isGameover=!1,this.blocks=[],this.ctx=t.getContext("2d"),this.bSpace=8*this.pixRatio,this.addListeners()}start(){this.isGameover=!1,this.updateSize(),this.blocks=this.genBlocks(),this.drawUI()}updateSize(){this.pixRatio=t(this.ctx);const s=this.cvs.offsetWidth*this.pixRatio;this.bSize=(s-(this.cols+1)*this.bSpace)/this.cols,this.cvs.width=this.cvs.height=s}genBlocks(){const t=s(this.rows).reduce(((t,e,o)=>[...t,...s(this.cols).map(((t,s)=>({row:o,col:s,num:0})))]),[]).sort((()=>Math.random()-.5));return t.slice(0,2).forEach((t=>{t.num=2})),t}drawUI(){const{cvs:t,ctx:s,bSize:o,bSpace:i}=this,r=t=>(o+i)*t+i,c=6*this.pixRatio;s.clearRect(0,0,t.width,t.height),this.blocks.forEach((t=>{if(t.num){s.save(),s.fillStyle=d[t.num].bgcolor,e(s,r(t.col),r(t.row),o,o,c),s.fill();const i=t.num+"",l=o/(i.length>2?3:2);s.fillStyle=d[t.num].color,s.font=`bold ${l}px serif`,s.textBaseline="top";const a=s.measureText(i).width;s.fillText(i,r(t.col)+(o-a)/2,r(t.row)+(o-l)/2),s.restore()}else s.save(),s.fillStyle="#eee4da",s.globalAlpha=.35,e(s,r(t.col),r(t.row),o,o,c),s.fill(),s.restore()}))}getColBlocks(t){return this.blocks.filter((s=>s.col===t))}getRowBlocks(t){return this.blocks.filter((s=>s.row===t))}moveBlocks(t){const e=t=>{let s=t.map((t=>t.num)).filter((t=>t));for(let e=0,o=s.length;e<o;e++){let t=s[e];if(s[e+1]===t){s[e]=2*t,s[e+1]=0;break}}s=s.filter((t=>t)),t.forEach(((t,e)=>{t.num=s[e]}))};if([1,3].includes(t)){const o=1===t?(t,s)=>t.row-s.row:(t,s)=>s.row-t.row;s(this.cols).forEach(((t,s)=>{e(this.getColBlocks(s).sort(o))}))}else if([2,4].includes(t)){const o=4===t?(t,s)=>t.col-s.col:(t,s)=>s.col-t.col;s(this.rows).forEach(((t,s)=>{e(this.getRowBlocks(s).sort(o))}))}t&&(this.genRandBlock(),this.drawUI(),this.checkResult())}genRandBlock(){const t=this.blocks.filter((t=>!t.num)).sort((()=>Math.random()-.5));t.length&&(t[0].num=2)}checkResult(){if(this.blocks.some((t=>2048===t.num)))return this.isGameover=!0,o(this.callbacks.onDone);if(this.blocks.some((t=>!t.num)))return;var t,s;(s=t||(t={}))[s.ROW=0]="ROW",s[s.COL=1]="COL";const e=t=>{const s=0===t?this.rows:this.cols;for(let e=0;e<s;e++){const s=(0===t?this.getRowBlocks(e).sort(((t,s)=>t.col-s.col)):this.getColBlocks(e).sort(((t,s)=>t.row-s.row))).map((t=>t.num));for(let t=0,e=s.length;t<e;t++)if(s[t]===s[t+1])return!1}return!0};e(0)&&e(1)&&(this.isGameover=!0,o(this.callbacks.onOver))}onResize(){this.updateSize(),this.drawUI()}onKeyup(t){if(this.isGameover)return;const s=[[[87,38],1],[[68,39],2],[[83,40],3],[[65,37],4]].find((s=>s[0].includes(t.keyCode)));s&&this.moveBlocks(s[1])}onTouchstart(t){if(this.isGameover)return;t.preventDefault();const s=t.targetTouches[0];let e,o,i=s.pageX,r=s.pageY;const{cvs:c}=this,l=t=>{t.preventDefault();const s=t.targetTouches[0];e=s.pageX,o=s.pageY},a=()=>{if(void 0===e)return;const t=Math.abs(e-i),s=Math.abs(o-r);(t>6||s>6)&&(t>s?this.moveBlocks(e>i?2:4):this.moveBlocks(o>r?3:1)),c.removeEventListener("touchmove",l),c.removeEventListener("touchend",a)};c.addEventListener("touchmove",l),c.addEventListener("touchend",a)}addListeners(){const{cvs:t}=this;t.addEventListener("touchstart",this.onTouchstart.bind(this)),document.addEventListener("keyup",this.onKeyup.bind(this)),window.addEventListener("resize",this.onResize.bind(this))}removeListeners(){const{cvs:t}=this;t.removeEventListener("touchstart",this.onTouchstart),document.removeEventListener("keyup",this.onKeyup),window.removeEventListener("resize",this.onResize)}}var v={data:()=>({game:null}),mounted(){this.game=new u(this.$refs.canvas,{onDone:()=>{var t;alert("恭喜你！挑战成功！"),null==(t=this.game)||t.start()},onOver:()=>{alert("挑战失败！请点击[新游戏]，重新开始")}}),this.game.start()},unmounted(){var t;null==(t=this.game)||t.removeListeners(),this.game=null},methods:{onStart(){var t;null==(t=this.game)||t.start()}}};const m=n();i("data-v-fca0433a");const g={class:"container"},b={class:"dashboard"},p=a("div",{class:"title"},"2048",-1),k={class:"btns"},w={class:"game-ui"},R={ref:"canvas"};r();const L=m(((t,s,e,o,i,r)=>(c(),l("div",g,[a("div",b,[p,a("div",k,[a("button",{onClick:s[1]||(s[1]=(...t)=>r.onStart&&r.onStart(...t))},"新游戏")])]),a("div",w,[a("canvas",R,null,512)])]))));v.render=L,v.__scopeId="data-v-fca0433a";export default v;
